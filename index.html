<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Curling: Brasil vs Argentina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f172a;
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        canvas {
            display: block;
            background: #f8fbff;
        }
        .ui-container {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            pointer-events: none;
            z-index: 100;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 1.25rem;
            padding: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
        }
        #power-bar-container {
            position: relative;
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: visible;
            margin-top: 8px;
        }
        #power-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #eab308);
            border-radius: 10px;
        }
        #ideal-marker {
            position: absolute; top: -4px; bottom: -4px; width: 4px;
            background: #ef4444; left: 85%; z-index: 50; border-radius: 2px;
        }
        .team-badge {
            flex: 1;
            padding: 4px 8px;
            border-radius: 10px;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        .active-bra { border-color: #22c55e; background: #f0fdf4; }
        .active-arg { border-color: #3b82f6; background: #eff6ff; }
        
        .controls-layer {
            position: absolute;
            bottom: 20px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
        }

        .side-btns {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }

        .btn-round {
            width: 50px; height: 50px;
            background: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 20px; font-weight: bold;
            color: #1e293b;
            user-select: none;
            cursor: pointer;
        }

        #launch-btn {
            width: 80px; height: 80px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
            font-size: 9px; font-weight: 900;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            pointer-events: auto;
            border: 4px solid white;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
        }
        #launch-btn.ready { transform: scale(1.15); border-color: #fff; box-shadow: 0 0 25px rgba(255,255,255,0.5); }
        #launch-btn.disabled { background: #94a3b8 !important; box-shadow: none; opacity: 0.5; pointer-events: none; }

        /* Estilo para o modal de fim de jogo lateral */
        #game-over-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 280px;
            max-height: calc(100vh - 40px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            box-shadow: -10px 0 30px rgba(0,0,0,0.2);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 1.5rem;
            pointer-events: auto;
            overflow-y: auto;
        }

        .history-item {
            border-left: 4px solid #cbd5e1;
            padding-left: 10px;
            margin-bottom: 8px;
            font-size: 11px;
        }
    </style>
</head>
<body>

    <!-- Painel de Fim de Jogo Lateral -->
    <div id="game-over-panel">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-xl font-black text-slate-800 uppercase italic">Fim de Jogo</h2>
                <p id="winner-label" class="text-sm font-bold text-blue-600"></p>
            </div>
            <button onclick="location.reload()" class="bg-slate-800 text-white p-2 rounded-full hover:scale-110 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
            </button>
        </div>

        <div class="bg-slate-50 rounded-xl p-3 mb-4 border border-slate-100">
            <div class="flex justify-around items-center">
                <div class="text-center">
                    <span class="text-2xl">üáßüá∑</span>
                    <div id="final-bra-score" class="text-2xl font-black">0</div>
                </div>
                <div class="text-slate-300 font-bold">VS</div>
                <div class="text-center">
                    <span class="text-2xl">üá¶üá∑</span>
                    <div id="final-arg-score" class="text-2xl font-black">0</div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">An√°lise da Casa</h3>
            <div id="stones-list" class="space-y-1 max-height-[150px] overflow-y-auto">
                <!-- Dist√¢ncias das pedras inseridas via JS -->
            </div>
        </div>

        <div>
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">√öltimos Resultados</h3>
            <div id="match-history" class="space-y-2">
                <!-- Hist√≥rico inserido via JS -->
            </div>
        </div>
        
        <p class="mt-4 text-[9px] text-slate-400 italic text-center">Pode continuar a explorar a pista e dar zoom para ver detalhes.</p>
    </div>

    <div class="ui-container">
        <div class="glass-panel">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Copa Am√©rica Curling</span>
                <div id="last-stone-msg" class="hidden text-red-500 font-bold text-[10px] animate-pulse">√öLTIMA PEDRA!</div>
            </div>
            
            <div class="flex gap-2">
                <div id="card-bra" class="team-badge relative bg-slate-50">
                    <span class="text-sm">üáßüá∑</span>
                    <span id="bra-count" class="font-black text-slate-700">4</span>
                </div>
                <div id="card-arg" class="team-badge relative bg-slate-50">
                    <span class="text-sm">üá¶üá∑</span>
                    <span id="arg-count" class="font-black text-slate-700">4</span>
                </div>
            </div>

            <div id="power-bar-container">
                <div id="ideal-marker"></div>
                <div id="power-bar"></div>
            </div>
            <div class="flex justify-between mt-1 px-1">
                <span class="text-[9px] font-bold text-slate-400 uppercase">Suave</span>
                <span id="turn-info" class="text-[9px] font-bold uppercase text-slate-600">Vez: Brasil</span>
                <span class="text-[9px] font-bold text-red-500 uppercase">Ideal</span>
            </div>
        </div>
    </div>

    <div class="controls-layer">
        <div class="side-btns">
            <div class="btn-round" onclick="adjustZoom(0.15)">Ôºã</div>
            <div class="btn-round" onclick="adjustZoom(-0.15)">Ôºç</div>
            <div class="btn-round bg-slate-800 !text-white !text-[9px]" onclick="resetZoom()">RESET</div>
        </div>

        <button id="launch-btn">
            <span class="text-xl mb-1">ü•å</span>
            <span id="launch-text">PREPARAR</span>
        </button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const PHYSICS = {
            friction: 0.991,
            sweepFriction: 0.996,
            stopThreshold: 0.18, 
            maxInitialVel: 13.5,
            stoneRadius: 10,
            houseRadius: 80,
            rinkWidth: 350,
            powerFillSpeed: 0.45,
            houseY: 50
        };

        let state = {
            width: 0, height: 0,
            stones: [],
            currentStone: null,
            readyToLaunch: false,
            isCharging: false,
            power: 0,
            stonesLeft: 8,
            turn: 'bra',
            mouseX: 0, mouseY: 0,
            isSweeping: false,
            isPanning: false,
            panStartY: 0,
            gameOver: false,
            camera: { x: 0, y: 500, zoom: 1 },
            scoringStones: [] // IDs das pedras que marcaram ponto
        };

        function init() {
            resize();
            window.addEventListener('resize', resize);
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mousedown', handleMouseDown);
            window.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('touchstart', handleTouchStart, {passive: false});
            window.addEventListener('touchmove', handleTouchMove, {passive: false});
            window.addEventListener('touchend', handleTouchEnd);

            document.getElementById('launch-btn').addEventListener('click', toggleLaunchReady);

            loadHistory();
            requestAnimationFrame(update);
            updateUI();
        }

        function resize() {
            state.width = window.innerWidth;
            state.height = window.innerHeight;
            canvas.width = state.width;
            canvas.height = state.height;
            resetZoom();
        }

        function resetZoom() {
            state.camera.zoom = Math.min(state.width / 380, state.height / 1100);
            state.camera.y = state.gameOver ? PHYSICS.houseY : 500;
            state.camera.x = 0;
        }

        function adjustZoom(delta) {
            state.camera.zoom = Math.max(0.2, Math.min(3.5, state.camera.zoom + delta));
        }

        function toggleLaunchReady(e) {
            e.stopPropagation();
            if (state.gameOver || state.stones.some(s => s.moving)) return;
            state.readyToLaunch = !state.readyToLaunch;
            if (state.readyToLaunch) state.camera.y = 850;
            updateUI();
        }

        function handleMouseDown(e) {
            if (e.target.closest('.glass-panel') || e.target.closest('.controls-layer') || e.target.closest('#game-over-panel')) return;
            const anyMoving = state.stones.some(s => s.moving);
            if (anyMoving && state.currentStone && state.currentStone.moving) {
                state.isSweeping = true;
            } else if (state.readyToLaunch && !state.gameOver) {
                state.isCharging = true;
                state.power = 0;
            } else {
                state.isPanning = true;
                state.panStartY = e.clientY;
            }
        }

        function handleMouseMove(e) {
            updateMousePos(e.clientX, e.clientY);
            if (state.isPanning) {
                const dy = (e.clientY - state.panStartY) / state.camera.zoom;
                state.camera.y -= dy;
                state.panStartY = e.clientY;
            }
        }

        function handleMouseUp() {
            if (state.isCharging) {
                launchStone();
                state.isCharging = false;
                state.readyToLaunch = false;
            }
            state.isSweeping = false;
            state.isPanning = false;
            updateUI();
        }

        function handleTouchStart(e) {
            if (e.target.closest('.glass-panel') || e.target.closest('.controls-layer') || e.target.closest('#game-over-panel')) return;
            const touch = e.touches[0];
            updateMousePos(touch.clientX, touch.clientY);
            const anyMoving = state.stones.some(s => s.moving);
            if (anyMoving && state.currentStone && state.currentStone.moving) {
                state.isSweeping = true;
            } else if (state.readyToLaunch && !state.gameOver) {
                state.isCharging = true;
                state.power = 0;
            } else {
                state.isPanning = true;
                state.panStartY = touch.clientY;
            }
        }

        function handleTouchMove(e) {
            const touch = e.touches[0];
            updateMousePos(touch.clientX, touch.clientY);
            if (state.isPanning) {
                const dy = (touch.clientY - state.panStartY) / state.camera.zoom;
                state.camera.y -= dy;
                state.panStartY = touch.clientY;
            }
        }

        function handleTouchEnd() { handleMouseUp(); }

        function updateMousePos(ix, iy) {
            state.mouseX = (ix - state.width/2) / state.camera.zoom + state.camera.x;
            state.mouseY = (iy - state.height/2) / state.camera.zoom + state.camera.y;
        }

        function launchStone() {
            const startX = 0, startY = 950;
            const angle = Math.atan2(state.mouseY - startY, state.mouseX - startX);
            const force = (state.power / 100) * PHYSICS.maxInitialVel;
            
            const stone = {
                id: Date.now(),
                x: startX, y: startY,
                vx: Math.cos(angle) * force,
                vy: Math.sin(angle) * force,
                team: state.turn,
                color: state.turn === 'bra' ? '#22c55e' : '#3b82f6',
                handleColor: state.turn === 'bra' ? '#facc15' : '#ffffff',
                moving: true
            };
            state.stones.push(stone);
            state.currentStone = stone;
            state.stonesLeft--;
            state.turn = state.turn === 'bra' ? 'arg' : 'bra';
        }

        function update() {
            ctx.clearRect(0, 0, state.width, state.height);
            ctx.save();
            ctx.translate(state.width/2, state.height/2);
            ctx.scale(state.camera.zoom, state.camera.zoom);
            ctx.translate(-state.camera.x, -state.camera.y);

            drawRink();

            if (state.isCharging) {
                state.power = Math.min(state.power + PHYSICS.powerFillSpeed, 100);
                document.getElementById('power-bar').style.width = state.power + '%';
            }

            let stoneStoppedThisFrame = false;
            state.stones.forEach(s => {
                if (s.moving) {
                    const f = (state.isSweeping && s === state.currentStone) ? PHYSICS.sweepFriction : PHYSICS.friction;
                    s.vx *= f; s.vy *= f;
                    s.x += s.vx; s.y += s.vy;
                    if (Math.sqrt(s.vx*s.vx + s.vy*s.vy) < PHYSICS.stopThreshold) {
                        s.vx = 0; s.vy = 0; s.moving = false;
                        stoneStoppedThisFrame = true;
                    }
                    state.camera.y = s.y;
                }
                drawStone(s);
            });

            if (stoneStoppedThisFrame) {
                updateUI();
                if (state.stonesLeft === 0 && !state.stones.some(s => s.moving)) calculateScore();
            }

            checkCollisions();
            drawGuides();
            ctx.restore();
            requestAnimationFrame(update);
        }

        function checkCollisions() {
            for (let i = 0; i < state.stones.length; i++) {
                for (let j = i + 1; j < state.stones.length; j++) {
                    const s1 = state.stones[i], s2 = state.stones[j];
                    const dx = s2.x - s1.x, dy = s2.y - s1.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < PHYSICS.stoneRadius * 2) {
                        const angle = Math.atan2(dy, dx);
                        const sin = Math.sin(angle), cos = Math.cos(angle);
                        const vx1 = s1.vx * cos + s1.vy * sin, vy1 = s1.vy * cos - s1.vx * sin;
                        const vx2 = s2.vx * cos + s2.vy * sin, vy2 = s2.vy * cos - s2.vx * sin;
                        s1.vx = vx2 * cos - vy1 * sin; s1.vy = vy1 * cos + vx2 * sin;
                        s2.vx = vx1 * cos - vy2 * sin; s2.vy = vy2 * cos + vx1 * sin;
                        const overlap = (PHYSICS.stoneRadius * 2 - dist) / 2;
                        s1.x -= overlap * cos; s1.y -= overlap * sin;
                        s2.x += overlap * cos; s2.y += overlap * sin;
                        s1.moving = s2.moving = true;
                    }
                }
            }
        }

        function drawRink() {
            const w = PHYSICS.rinkWidth, houseY = PHYSICS.houseY; 
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(-w/2, -500, w, 2000);
            
            const rings = [
                { r: PHYSICS.houseRadius, c: '#3b82f6' }, 
                { r: PHYSICS.houseRadius * 0.66, c: '#ffffff' }, 
                { r: PHYSICS.houseRadius * 0.33, c: '#ef4444' }, 
                { r: 12, c: '#ffffff' }
            ];
            rings.forEach(ring => {
                ctx.beginPath(); ctx.arc(0, houseY, ring.r, 0, Math.PI * 2);
                ctx.fillStyle = ring.c; ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.stroke();
            });

            ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, -500); ctx.lineTo(0, 1500); ctx.stroke();
            ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(-w/2, houseY + 250); ctx.lineTo(w/2, houseY + 250); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-w/2, 800); ctx.lineTo(w/2, 800); ctx.stroke();
        }

        function drawStone(s) {
            const isScoring = state.scoringStones.includes(s.id);
            if (isScoring) {
                ctx.beginPath();
                ctx.arc(s.x, s.y, PHYSICS.stoneRadius + 4, 0, Math.PI * 2);
                ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 3; ctx.stroke();
            }

            ctx.shadowBlur = 5; ctx.shadowColor = 'rgba(0,0,0,0.2)';
            ctx.beginPath(); ctx.arc(s.x, s.y, PHYSICS.stoneRadius, 0, Math.PI * 2);
            ctx.fillStyle = s.color; ctx.fill();
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 1; ctx.stroke();
            ctx.shadowBlur = 0;
            ctx.beginPath(); ctx.arc(s.x, s.y, PHYSICS.stoneRadius * 0.55, 0, Math.PI * 2);
            ctx.fillStyle = s.handleColor; ctx.fill();

            // Dist√¢ncia se o jogo acabou
            if (state.gameOver) {
                const dist = Math.sqrt(s.x*s.x + (s.y - PHYSICS.houseY)**2).toFixed(1);
                ctx.fillStyle = "#1e293b"; ctx.font = "bold 8px Inter"; ctx.textAlign = "center";
                ctx.fillText(dist, s.x, s.y + 22);
            }
        }

        function drawGuides() {
            if (state.isCharging) {
                ctx.beginPath(); ctx.setLineDash([5, 5]);
                ctx.moveTo(0, 950); ctx.lineTo(state.mouseX, state.mouseY);
                ctx.strokeStyle = 'rgba(0,0,0,0.4)'; ctx.lineWidth = 2; ctx.stroke();
                ctx.setLineDash([]);
            }
            if (state.isSweeping && state.currentStone && state.currentStone.moving) {
                ctx.beginPath();
                ctx.ellipse(state.currentStone.x, state.currentStone.y - 25, 25, 12, 0, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(56, 189, 248, 0.4)'; ctx.fill();
            }
        }

        function calculateScore() {
            state.gameOver = true;
            const houseY = PHYSICS.houseY;
            const stonesInfo = state.stones.map(s => ({
                id: s.id, team: s.team,
                dist: Math.sqrt(s.x*s.x + (s.y - houseY)**2)
            })).filter(s => s.dist <= PHYSICS.houseRadius);

            stonesInfo.sort((a, b) => a.dist - b.dist);

            let braScore = 0, argScore = 0;
            let winner = "Ningu√©m";
            state.scoringStones = [];

            if (stonesInfo.length > 0) {
                winner = stonesInfo[0].team;
                const loser = winner === 'bra' ? 'arg' : 'bra';
                const firstOpponentStone = stonesInfo.find(s => s.team === loser);
                const limitDist = firstOpponentStone ? firstOpponentStone.dist : PHYSICS.houseRadius + 1;
                
                const winners = stonesInfo.filter(s => s.team === winner && s.dist < limitDist);
                const points = winners.length;
                state.scoringStones = winners.map(w => w.id);
                
                if (winner === 'bra') braScore = points; else argScore = points;
                winner = winner === 'bra' ? "Brasil üáßüá∑" : "Argentina üá¶üá∑";
            }

            document.getElementById('final-bra-score').innerText = braScore;
            document.getElementById('final-arg-score').innerText = argScore;
            document.getElementById('winner-label').innerText = winner === "Ningu√©m" ? "Empate t√©cnico!" : winner + " venceu!";
            
            // Listar dist√¢ncias no painel
            const list = document.getElementById('stones-list');
            list.innerHTML = state.stones.sort((a,b) => {
                const da = Math.sqrt(a.x*a.x + (a.y - houseY)**2);
                const db = Math.sqrt(b.x*b.x + (b.y - houseY)**2);
                return da - db;
            }).map(s => {
                const dist = Math.sqrt(s.x*s.x + (s.y - houseY)**2);
                const inHouse = dist <= PHYSICS.houseRadius;
                return `<div class="flex justify-between items-center text-[10px] p-1 ${inHouse ? 'bg-white' : 'opacity-40'} rounded border border-slate-100">
                    <span class="font-bold">${s.team === 'bra' ? 'üáßüá∑' : 'üá¶üá∑'} Pedra</span>
                    <span class="font-mono">${dist.toFixed(1)}u ${inHouse ? 'üéØ' : ''}</span>
                </div>`;
            }).join('');

            saveResult(winner, braScore, argScore);
            document.getElementById('game-over-panel').style.display = 'flex';
            updateUI();
        }

        function saveResult(winner, bra, arg) {
            let history = JSON.parse(localStorage.getItem('curling_history') || '[]');
            history.unshift({ winner, bra, arg, date: new Date().toLocaleTimeString() });
            history = history.slice(0, 3);
            localStorage.setItem('curling_history', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('curling_history') || '[]');
            const container = document.getElementById('match-history');
            if (history.length === 0) {
                container.innerHTML = '<p class="text-[10px] text-slate-400 italic">Sem partidas anteriores.</p>';
                return;
            }
            container.innerHTML = history.map(h => `
                <div class="history-item">
                    <div class="font-bold">${h.winner}</div>
                    <div class="text-slate-500">üáßüá∑ ${h.bra} - ${h.arg} üá¶üá∑ <span class="text-[8px] opacity-50 ml-1">${h.date}</span></div>
                </div>
            `).join('');
        }

        function updateUI() {
            const anyMoving = state.stones.some(s => s.moving);
            document.getElementById('bra-count').innerText = Math.ceil(state.stonesLeft / 2);
            document.getElementById('arg-count').innerText = Math.floor(state.stonesLeft / 2);
            
            const lBtn = document.getElementById('launch-btn');
            const lText = document.getElementById('launch-text');

            if (state.gameOver) {
                lBtn.classList.add('disabled');
                lText.innerText = "FIM";
                return;
            }

            if (anyMoving) {
                lBtn.classList.add('disabled');
                lText.innerText = "ESPERE";
            } else {
                lBtn.classList.remove('disabled');
                lBtn.style.backgroundColor = state.turn === 'bra' ? '#22c55e' : '#3b82f6';
                if (state.readyToLaunch) {
                    lBtn.classList.add('ready');
                    lText.innerText = "TOQUE P/ LAN√áAR";
                } else {
                    lBtn.classList.remove('ready');
                    lText.innerText = "PREPARAR";
                }
            }
        }

        init();
    </script>
</body>
</html>
