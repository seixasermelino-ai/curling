<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Curling Master Pro - Precision Controls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f172a;
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        canvas { display: block; background: #f8fbff; }
        
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            z-index: 500;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            color: white;
            justify-content: center;
            align-items: center;
        }

        .game-ui {
            position: absolute; top: 0; left: 0; right: 0;
            pointer-events: none; z-index: 100;
            padding: 10px;
        }
        .scoreboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 8px 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            pointer-events: auto;
            max-width: 550px; margin: 0 auto;
        }

        .flag-img {
            width: 32px;
            height: 22px;
            object-fit: cover;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .power-meter-container {
            position: absolute; left: 50%; bottom: 130px;
            transform: translateX(-50%);
            width: 300px;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .power-meter {
            width: 100%; height: 16px;
            background: rgba(0,0,0,0.15);
            border-radius: 8px; overflow: hidden;
            position: relative;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .power-markers {
            position: absolute; inset: 0;
            display: flex; justify-content: space-evenly;
            pointer-events: none;
        }
        .marker {
            width: 2px; height: 100%;
            background: rgba(0,0,0,0.2);
            position: relative;
        }
        .marker::after {
            content: attr(data-label);
            position: absolute; top: -18px; left: 50%;
            transform: translateX(-50%);
            font-size: 9px; font-weight: 900; color: #1e293b;
        }

        .spin-selector {
            position: absolute; bottom: 110px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 4px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            pointer-events: auto; z-index: 150;
            transition: opacity 0.3s;
        }
        .spin-opt {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 900; color: #64748b;
            cursor: pointer; transition: all 0.2s;
        }
        .spin-opt.active { background: #3b82f6; color: white; transform: scale(1.1); }

        #launch-btn {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 70px; height: 70px;
            border-radius: 50%; border: 4px solid white;
            color: white; font-weight: 900; font-size: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; cursor: pointer;
            text-align: center;
            z-index: 200;
        }
        #launch-btn.ready { transform: translateX(-50%) scale(1.1); box-shadow: 0 0 20px rgba(255,255,255,0.4); }

        #replay-btn {
            position: absolute; bottom: 30px; left: 30px;
            background: #f59e0b; color: white; padding: 12px 20px;
            border-radius: 12px; font-weight: 900; font-size: 12px;
            display: none; align-items: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            cursor: pointer; pointer-events: auto; z-index: 200;
            text-transform: uppercase;
        }

        #end-card {
            position: absolute; top: 80px; right: 15px;
            width: 220px; background: white; border-radius: 1rem;
            padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none; z-index: 150; pointer-events: auto;
        }

        .country-opt {
            cursor: pointer; transition: all 0.2s;
            border: 2px solid #334155;
            background: #1e293b;
            position: relative;
        }
        .country-opt.selected { border-color: #3b82f6; background: #0f172a; }

        .stone-preview {
            width: 20px; height: 20px;
            border-radius: 50%;
            border: 1px solid #000;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .handle-preview {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: white;
        }

        .zoom-controls {
            position: absolute; bottom: 30px; right: 20px;
            display: flex; flex-direction: column; gap: 8px;
            pointer-events: auto; z-index: 150;
        }
        .zoom-btn {
            width: 50px; height: 50px; background: white;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; font-size: 24px;
            color: #1e293b; cursor: pointer; user-select: none; transition: background 0.2s;
        }
        .zoom-btn:active { background: #f1f5f9; }
        
        .replay-overlay {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(220, 38, 38, 0.8); color: white;
            padding: 5px 15px; border-radius: 5px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            display: none; pointer-events: none; z-index: 300;
        }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1 class="text-4xl font-black italic mb-6 tracking-tighter uppercase text-center">
            <span class="text-blue-500">Curling</span> Master
        </h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl mb-8">
            <div class="space-y-3">
                <p class="text-[11px] font-black uppercase text-slate-500 tracking-widest text-center">Time 1 (Lan√ßa Primeiro)</p>
                <div id="team1-list" class="grid grid-cols-2 gap-2"></div>
            </div>
            <div class="space-y-3">
                <p class="text-[11px] font-black uppercase text-slate-500 tracking-widest text-center">Time 2 (O Martelo)</p>
                <div id="team2-list" class="grid grid-cols-2 gap-2"></div>
            </div>
        </div>

        <button onclick="startGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-black px-12 py-4 rounded-full transition-all shadow-xl shadow-blue-900/40 uppercase italic tracking-widest active:scale-95">
            Come√ßar Partida
        </button>
    </div>

    <div class="replay-overlay" id="replay-overlay">‚óè REPLAY SLOW-MO</div>

    <div class="game-ui">
        <div class="scoreboard">
            <div class="flex items-center gap-3">
                <img id="ui-t1-flag" src="" class="flag-img">
                <div>
                    <div id="ui-t1-name" class="text-[10px] font-black uppercase text-slate-400 leading-none">BRA</div>
                    <div id="ui-t1-score" class="text-xl font-black text-slate-800 leading-tight">0</div>
                </div>
            </div>

            <div class="flex flex-col items-center">
                <div id="turn-indicator" class="text-[9px] font-black uppercase tracking-tighter text-white px-4 py-1.5 rounded-full mb-1 shadow-sm">Brasil joga</div>
                <div class="flex gap-1" id="stones-tracker"></div>
            </div>

            <div class="flex items-center gap-3 text-right">
                <div>
                    <div id="ui-t2-name" class="text-[10px] font-black uppercase text-slate-400 leading-none">ARG</div>
                    <div id="ui-t2-score" class="text-xl font-black text-slate-800 leading-tight">0</div>
                </div>
                <img id="ui-t2-flag" src="" class="flag-img">
            </div>
        </div>
    </div>

    <div class="spin-selector" id="spin-ui">
        <div class="spin-opt" onclick="setSpin(-3)">L3</div>
        <div class="spin-opt" onclick="setSpin(-2)">L2</div>
        <div class="spin-opt" onclick="setSpin(-1)">L1</div>
        <div class="spin-opt active" onclick="setSpin(0)">0</div>
        <div class="spin-opt" onclick="setSpin(1)">R1</div>
        <div class="spin-opt" onclick="setSpin(2)">R2</div>
        <div class="spin-opt" onclick="setSpin(3)">R3</div>
    </div>

    <div class="power-meter-container" id="power-ui">
        <div class="power-meter">
            <div id="power-fill" class="h-full w-0 bg-gradient-to-r from-green-400 via-yellow-400 to-red-500"></div>
            <div class="power-markers">
                <div class="marker" data-label="25%"></div>
                <div class="marker" data-label="50%"></div>
                <div class="marker" data-label="75%"></div>
            </div>
        </div>
    </div>

    <div class="zoom-controls">
        <div class="zoom-btn" onclick="adjustZoom(1.2)">üîç+</div>
        <div class="zoom-btn" onclick="adjustZoom(0.8)">üîç-</div>
    </div>

    <div id="end-card">
        <h3 class="text-xs font-black uppercase mb-2 text-slate-800 border-b pb-1">An√°lise da Casa</h3>
        <div id="end-summary" class="text-sm font-black text-blue-600 mb-3"></div>
        <div id="mini-dist-list" class="space-y-1 mb-4 max-h-[180px] overflow-y-auto"></div>
        <button onclick="location.reload()" class="w-full bg-blue-600 text-white text-[10px] py-2.5 rounded-lg font-black uppercase tracking-widest shadow-md">Nova Partida</button>
    </div>

    <div id="launch-btn">
        <span class="text-lg">ü•å</span>
        <span id="launch-text">PREPARAR</span>
    </div>

    <div id="replay-btn" onclick="startReplay()">
        <span>üé•</span> REVER JOGADA
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const COUNTRIES = [
            { id: 'br', name: 'Brasil', code: 'BRA', color: '#22c55e', handle: '#facc15' },
            { id: 'ar', name: 'Argentina', code: 'ARG', color: '#3b82f6', handle: '#ffffff' },
            { id: 'ca', name: 'Canad√°', code: 'CAN', color: '#ef4444', handle: '#ffffff' },
            { id: 'gb-sct', name: 'Esc√≥cia', code: 'SCO', color: '#1e40af', handle: '#cbd5e1' },
            { id: 'se', name: 'Su√©cia', code: 'SWE', color: '#eab308', handle: '#1e3a8a' },
            { id: 'no', name: 'Noruega', code: 'NOR', color: '#991b1b', handle: '#ffffff' },
            { id: 'jp', name: 'Jap√£o', code: 'JPN', color: '#f87171', handle: '#ffffff' },
            { id: 'us', name: 'EUA', code: 'USA', color: '#1e293b', handle: '#ef4444' }
        ];

        let team1 = COUNTRIES[0];
        let team2 = COUNTRIES[1];

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const PHYSICS = {
            friction: 0.992,
            angularFriction: 0.985,
            sweepFriction: 0.997,
            stopThreshold: 0.03,
            maxInitialVel: 11.8,
            stoneRadius: 10,
            houseRadius: 80,
            rinkWidth: 350,
            powerFillSpeed: 0.55,
            houseY: 60,
            spinPower: 0.025,
            launchY: 950
        };

        let state = {
            width: 0, height: 0,
            stones: [],
            currentStone: null,
            readyToLaunch: false,
            isCharging: false,
            power: 0,
            selectedSpin: 0, 
            stonesLeft: 8,
            turn: 1, 
            mouseX: 0, mouseY: 0,
            isSweeping: false,
            isPanning: false,
            panStartY: 0,
            gameOver: false,
            camera: { x: 0, y: 500, zoom: 0.8 },
            shouldCameraFollow: true,
            scoringStones: [],
            
            isReplaying: false,
            replayIndex: 0,
            lastLaunchData: [],
            replaySpeedFactor: 0.5
        };

        function setSpin(val) {
            if (state.isCharging || state.stones.some(s => s.moving) || state.isReplaying) return;
            state.selectedSpin = val;
            const opts = document.querySelectorAll('.spin-opt');
            opts.forEach((opt, i) => {
                opt.classList.toggle('active', (i - 3) === val);
            });
        }

        function getFlagUrl(id) {
            return `https://flagcdn.com/w80/${id}.png`;
        }

        function populateMenus() {
            const t1 = document.getElementById('team1-list');
            const t2 = document.getElementById('team2-list');
            COUNTRIES.forEach(c => {
                t1.appendChild(createCountryBtn(c, 1));
                t2.appendChild(createCountryBtn(c, 2));
            });
            updateSelectionUI();
        }

        function createCountryBtn(c, teamNum) {
            const div = document.createElement('div');
            div.className = `country-opt p-2 rounded-lg flex items-center gap-2 text-[11px] font-bold`;
            div.innerHTML = `
                <img src="${getFlagUrl(c.id)}" class="w-5 h-3.5 object-cover rounded-sm">
                <span class="flex-1">${c.code}</span>
                <div class="stone-preview" style="background-color: ${c.color}">
                    <div class="handle-preview" style="background-color: ${c.handle}"></div>
                </div>
            `;
            div.onclick = () => {
                if (teamNum === 1) team1 = c; else team2 = c;
                updateSelectionUI();
            };
            div.dataset.id = c.id;
            div.dataset.team = teamNum;
            return div;
        }

        function updateSelectionUI() {
            document.querySelectorAll('.country-opt').forEach(btn => {
                const teamNum = parseInt(btn.dataset.team);
                const currentId = teamNum === 1 ? team1.id : team2.id;
                btn.classList.toggle('selected', btn.dataset.id === currentId);
            });
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui-t1-flag').src = getFlagUrl(team1.id);
            document.getElementById('ui-t1-name').innerText = team1.code;
            document.getElementById('ui-t2-flag').src = getFlagUrl(team2.id);
            document.getElementById('ui-t2-name').innerText = team2.code;
            initGame();
        }

        function initGame() {
            resize();
            window.addEventListener('resize', resize);
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mousedown', handleMouseDown);
            window.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('touchstart', handleTouchStart, {passive: false});
            window.addEventListener('touchmove', handleTouchMove, {passive: false});
            window.addEventListener('touchend', handleTouchEnd);
            document.getElementById('launch-btn').addEventListener('click', toggleLaunchReady);
            requestAnimationFrame(update);
            updateUI();
        }

        function resize() {
            state.width = window.innerWidth;
            state.height = window.innerHeight;
            canvas.width = state.width;
            canvas.height = state.height;
        }

        // Fun√ß√£o de zoom corrigida: Atualiza o zoom e garante o redesenho imediato
        function adjustZoom(factor) {
            const oldZoom = state.camera.zoom;
            state.camera.zoom *= factor;
            
            // Limites de zoom
            state.camera.zoom = Math.max(0.3, Math.min(3.0, state.camera.zoom));
            
            // Reajusta a posi√ß√£o para o zoom parecer "centralizado" se necess√°rio
            // (Neste caso, o motor de renderiza√ß√£o cuida disso no translate principal)
        }

        function stopReplay() {
            if (state.isReplaying) {
                state.isReplaying = false;
                document.getElementById('replay-overlay').style.display = 'none';
                document.getElementById('replay-btn').style.display = 'flex';
            }
        }

        function toggleLaunchReady(e) {
            e.stopPropagation();
            if (state.gameOver || state.stones.some(s => s.moving)) return;
            
            stopReplay();
            state.readyToLaunch = !state.readyToLaunch;
            // Quando preparar, foca na zona de lan√ßamento
            if (state.readyToLaunch) state.camera.y = 850; 
            updateUI();
        }

        function handleMouseDown(e) {
            if (state.isReplaying) return;
            // Ignora clicks na interface
            if (e.target.closest('.scoreboard') || e.target.closest('#launch-btn') || e.target.closest('#end-card') || e.target.closest('.zoom-controls') || e.target.closest('.spin-selector') || e.target.closest('#replay-btn')) return;
            
            const anyMoving = state.stones.some(s => s.moving);
            if (anyMoving) {
                state.isSweeping = true;
            } else if (state.readyToLaunch && !state.gameOver) {
                state.isCharging = true;
                state.power = 0;
            } else {
                state.isPanning = true;
                state.panStartY = e.clientY;
            }
        }

        function handleMouseMove(e) {
            updateMousePos(e.clientX, e.clientY);
            if (state.isPanning) {
                state.camera.y -= (e.clientY - state.panStartY) / state.camera.zoom;
                state.panStartY = e.clientY;
            }
        }

        function handleMouseUp() {
            if (state.isCharging) { launchStone(); state.isCharging = false; state.readyToLaunch = false; }
            state.isSweeping = false; state.isPanning = false; updateUI();
        }

        function handleTouchStart(e) {
            if (state.isReplaying) return;
            if (e.target.closest('.scoreboard') || e.target.closest('#launch-btn') || e.target.closest('#end-card') || e.target.closest('.zoom-controls') || e.target.closest('.spin-selector') || e.target.closest('#replay-btn')) return;
            const touch = e.touches[0];
            updateMousePos(touch.clientX, touch.clientY);
            const anyMoving = state.stones.some(s => s.moving);
            if (anyMoving) {
                state.isSweeping = true;
            } else if (state.readyToLaunch && !state.gameOver) {
                state.isCharging = true;
                state.power = 0;
            } else {
                state.isPanning = true;
                state.panStartY = touch.clientY;
            }
        }

        function handleTouchMove(e) {
            const touch = e.touches[0];
            updateMousePos(touch.clientX, touch.clientY);
            if (state.isPanning) {
                state.camera.y -= (touch.clientY - state.panStartY) / state.camera.zoom;
                state.panStartY = touch.clientY;
            }
        }

        function handleTouchEnd() { handleMouseUp(); }

        function updateMousePos(ix, iy) {
            state.mouseX = (ix - state.width/2) / state.camera.zoom + state.camera.x;
            state.mouseY = (iy - state.height/2) / state.camera.zoom + state.camera.y;
        }

        function launchStone() {
            const startX = 0, startY = PHYSICS.launchY;
            const angle = Math.atan2(state.mouseY - startY, state.mouseX - startX);
            const force = (state.power / 100) * PHYSICS.maxInitialVel;
            const activeTeam = state.turn === 1 ? team1 : team2;
            
            const stone = {
                id: Date.now(),
                x: startX, y: startY,
                vx: Math.cos(angle) * force,
                vy: Math.sin(angle) * force,
                spin: state.selectedSpin, 
                team: state.turn,
                color: activeTeam.color,
                handleColor: activeTeam.handle,
                flagId: activeTeam.id,
                moving: true,
                rotation: 0 
            };

            // L√ìGICA DE C√ÇMERA INTELIGENTE
            const houseScreenY = (PHYSICS.houseY - state.camera.y) * state.camera.zoom + (state.height / 2);
            const launchScreenY = (PHYSICS.launchY - state.camera.y) * state.camera.zoom + (state.height / 2);
            const margin = state.height * 0.15; // Margem de seguran√ßa um pouco maior

            if (houseScreenY < margin || launchScreenY > state.height - margin) {
                state.shouldCameraFollow = true;
            } else {
                state.shouldCameraFollow = false;
            }

            state.stones.push(stone);
            state.currentStone = stone;
            state.stonesLeft--;
            state.turn = state.turn === 1 ? 2 : 1;
            state.selectedSpin = 0; 
            state.lastLaunchData = []; 
            setSpin(0);
        }

        function startReplay() {
            if (state.lastLaunchData.length === 0 || state.isReplaying) return;
            state.isReplaying = true;
            state.replayIndex = 0;
            document.getElementById('replay-overlay').style.display = 'block';
            document.getElementById('replay-btn').style.display = 'none';
        }

        function update() {
            ctx.clearRect(0, 0, state.width, state.height);
            
            if (state.isReplaying) {
                runReplayFrame();
            } else {
                runNormalFrame();
            }

            requestAnimationFrame(update);
        }

        function runNormalFrame() {
            ctx.save();
            ctx.translate(state.width/2, state.height/2);
            ctx.scale(state.camera.zoom, state.camera.zoom);
            ctx.translate(-state.camera.x, -state.camera.y);

            drawRink();

            if (state.isCharging) {
                state.power += PHYSICS.powerFillSpeed;
                if (state.power > 100) state.power = 0;
                document.getElementById('power-fill').style.width = state.power + '%';
            }

            let stoneStoppedThisFrame = false;
            let anyMoving = false;

            state.stones.forEach(s => {
                if (s.moving) {
                    anyMoving = true;
                    const f = (state.isSweeping) ? PHYSICS.sweepFriction : PHYSICS.friction;
                    const af = PHYSICS.angularFriction;
                    const speed = Math.sqrt(s.vx*s.vx + s.vy*s.vy);
                    
                    s.vx *= f;
                    s.vy *= f;
                    s.spin *= af;

                    if (Math.abs(s.spin) > 0.05) {
                        const curlEffect = (s.spin * PHYSICS.spinPower) * (1 / (speed + 0.5));
                        s.vx += curlEffect;
                        s.rotation += (s.spin * 0.04);
                    }

                    s.x += s.vx;
                    s.y += s.vy;

                    if (speed < PHYSICS.stopThreshold) {
                        s.vx = 0; s.vy = 0; s.spin = 0; s.moving = false;
                        stoneStoppedThisFrame = true;
                    }
                    
                    // Segue a pedra se necess√°rio
                    if (s === state.currentStone && state.shouldCameraFollow) {
                        state.camera.y += (s.y - state.camera.y) * 0.08;
                    }
                }
                drawStone(s);
            });

            if (anyMoving) {
                state.lastLaunchData.push(state.stones.map(s => ({...s})));
            }

            if (stoneStoppedThisFrame) {
                const stillMoving = state.stones.some(s => s.moving);
                if (!stillMoving) {
                    updateUI();
                    if (state.stonesLeft === 0) calculateScore();
                    else document.getElementById('replay-btn').style.display = 'flex';
                }
            }

            checkCollisions();
            drawGuides();
            ctx.restore();
        }

        function runReplayFrame() {
            const frameToDisplay = Math.floor(state.replayIndex);
            if (frameToDisplay >= state.lastLaunchData.length) {
                stopReplay();
                return;
            }

            const currentFrame = state.lastLaunchData[frameToDisplay];
            
            ctx.save();
            ctx.translate(state.width/2, state.height/2);
            ctx.scale(state.camera.zoom, state.camera.zoom);
            ctx.translate(-state.camera.x, -state.camera.y);
            drawRink();
            currentFrame.forEach(s => drawStone(s));
            ctx.restore();
            state.replayIndex += state.replaySpeedFactor;
        }

        function checkCollisions() {
            for (let i = 0; i < state.stones.length; i++) {
                for (let j = i + 1; j < state.stones.length; j++) {
                    const s1 = state.stones[i], s2 = state.stones[j];
                    const dx = s2.x - s1.x, dy = s2.y - s1.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < PHYSICS.stoneRadius * 2) {
                        const angle = Math.atan2(dy, dx);
                        const sin = Math.sin(angle), cos = Math.cos(angle);
                        const vx1 = s1.vx * cos + s1.vy * sin, vy1 = s1.vy * cos - s1.vx * sin;
                        const vx2 = s2.vx * cos + s2.vy * sin, vy2 = s2.vy * cos - s2.vx * sin;
                        s1.vx = vx2 * cos - vy1 * sin; s1.vy = vy1 * cos + vx2 * sin;
                        s2.vx = vx1 * cos - vy2 * sin; s2.vy = vy2 * cos + vx1 * sin;
                        const overlap = (PHYSICS.stoneRadius * 2 - dist) / 2;
                        s1.x -= overlap * cos; s1.y -= overlap * sin;
                        s2.x += overlap * cos; s2.y += overlap * sin;
                        s1.moving = s2.moving = true;
                    }
                }
            }
        }

        function drawRink() {
            const w = PHYSICS.rinkWidth, houseY = PHYSICS.houseY; 
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(-w/2, -500, w, 2000);
            
            const rings = [
                { r: PHYSICS.houseRadius, c: '#3b82f6' }, 
                { r: PHYSICS.houseRadius * 0.66, c: '#ffffff' }, 
                { r: PHYSICS.houseRadius * 0.33, c: '#ef4444' }, 
                { r: 12, c: '#ffffff' }
            ];
            rings.forEach(ring => {
                ctx.beginPath(); ctx.arc(0, houseY, ring.r, 0, Math.PI * 2);
                ctx.fillStyle = ring.c; ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.stroke();
            });

            ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, -500); ctx.lineTo(0, 1500); ctx.stroke();
            ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(-w/2, 800); ctx.lineTo(w/2, 800); ctx.stroke();
        }

        function drawStone(s) {
            ctx.save();
            ctx.translate(s.x, s.y);
            
            const isScoring = state.scoringStones.includes(s.id);
            if (isScoring) {
                ctx.beginPath(); ctx.arc(0, 0, PHYSICS.stoneRadius + 4, 0, Math.PI * 2);
                ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 3; ctx.stroke();
            }

            ctx.beginPath(); ctx.arc(0, 0, PHYSICS.stoneRadius, 0, Math.PI * 2);
            ctx.fillStyle = s.color; ctx.fill();
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 1; ctx.stroke();
            
            ctx.rotate(s.rotation || 0);
            ctx.beginPath(); ctx.arc(0, 0, PHYSICS.stoneRadius * 0.55, 0, Math.PI * 2);
            ctx.fillStyle = s.handleColor; ctx.fill();
            ctx.fillStyle = "rgba(0,0,0,0.2)";
            ctx.fillRect(-2, -PHYSICS.stoneRadius * 0.4, 4, PHYSICS.stoneRadius * 0.8);
            ctx.restore();

            if (state.gameOver) {
                const dist = Math.sqrt(s.x*s.x + (s.y - PHYSICS.houseY)**2).toFixed(1);
                ctx.fillStyle = "#1e293b"; ctx.font = "bold 9px Inter";
                ctx.textAlign = "center";
                ctx.fillText(dist, s.x, s.y + 24);
            }
        }

        function drawGuides() {
            if (state.isCharging) {
                const startX = 0, startY = PHYSICS.launchY;
                const angle = Math.atan2(state.mouseY - startY, state.mouseX - startX);
                const maxLen = 140;
                const currentLen = (state.power / 100) * maxLen;
                const arrowWidth = 18;

                ctx.save();
                ctx.translate(startX, startY);
                ctx.rotate(angle);

                ctx.beginPath();
                ctx.moveTo(0, -arrowWidth/2);
                ctx.lineTo(maxLen, -arrowWidth/2);
                ctx.lineTo(maxLen + 15, 0);
                ctx.lineTo(maxLen, arrowWidth/2);
                ctx.lineTo(0, arrowWidth/2);
                ctx.closePath();
                ctx.fillStyle = 'rgba(0,0,0,0.05)';
                ctx.fill();

                const grad = ctx.createLinearGradient(0, 0, maxLen, 0);
                grad.addColorStop(0, '#4ade80');
                grad.addColorStop(0.5, '#facc15');
                grad.addColorStop(1, '#ef4444');

                ctx.beginPath();
                ctx.moveTo(0, -arrowWidth/2);
                ctx.lineTo(currentLen, -arrowWidth/2);
                ctx.lineTo(currentLen + (currentLen > 0 ? 8 : 0), 0);
                ctx.lineTo(currentLen, arrowWidth/2);
                ctx.lineTo(0, arrowWidth/2);
                ctx.closePath();
                ctx.fillStyle = grad;
                ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.stroke();
                ctx.restore();
            }
            if (state.isSweeping && state.stones.some(s => s.moving)) {
                ctx.save();
                ctx.beginPath();
                const ms = state.stones.find(s => s.moving) || {x:0, y:0};
                ctx.ellipse(ms.x, ms.y - 15, 25, 12, 0, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(56, 189, 248, 0.3)';
                ctx.fill();
                ctx.restore();
            }
        }

        function calculateScore() {
            state.gameOver = true;
            const stonesInfo = state.stones.map(s => ({
                id: s.id, team: s.team, flagId: s.flagId,
                dist: Math.sqrt(s.x*s.x + (s.y - PHYSICS.houseY)**2)
            })).filter(s => s.dist <= PHYSICS.houseRadius);
            stonesInfo.sort((a, b) => a.dist - b.dist);

            let s1 = 0, s2 = 0;
            if (stonesInfo.length > 0) {
                const winner = stonesInfo[0].team;
                const loser = winner === 1 ? 2 : 1;
                const firstOppStone = stonesInfo.find(s => s.team === loser);
                const limit = firstOppStone ? firstOppStone.dist : PHYSICS.houseRadius + 1;
                const winners = stonesInfo.filter(s => s.team === winner && s.dist < limit);
                if (winner === 1) s1 = winners.length; else s2 = winners.length;
                state.scoringStones = winners.map(w => w.id);
            }

            document.getElementById('ui-t1-score').innerText = s1;
            document.getElementById('ui-t2-score').innerText = s2;
            document.getElementById('end-summary').innerText = s1 > s2 ? `${team1.name} Ganhou!` : (s2 > s1 ? `${team2.name} Ganhou!` : "Empate!");
            
            const list = document.getElementById('mini-dist-list');
            list.innerHTML = state.stones.sort((a,b) => {
                const d1 = Math.sqrt(a.x*a.x + (a.y - PHYSICS.houseY)**2);
                const d2 = Math.sqrt(b.x*b.x + (b.y - PHYSICS.houseY)**2);
                return d1 - d2;
            }).map(s => {
                const dist = Math.sqrt(s.x*s.x + (s.y - PHYSICS.houseY)**2);
                const inHouse = dist <= PHYSICS.houseRadius;
                return `<div class="flex justify-between items-center text-[11px] p-2 border-b ${inHouse ? 'bg-blue-50' : 'opacity-40'}">
                    <div class="flex items-center gap-2">
                        <img src="${getFlagUrl(s.flagId)}" class="w-4 h-2.5 rounded-xs">
                        <span class="font-bold">Pedra</span>
                    </div>
                    <span class="font-mono font-black">${dist.toFixed(1)}u</span>
                </div>`;
            }).join('');

            document.getElementById('end-card').style.display = 'block';
            document.getElementById('replay-btn').style.display = 'none';
            updateUI();
        }

        function updateUI() {
            if (state.isReplaying) return;
            const anyMoving = state.stones.some(s => s.moving);
            const tracker = document.getElementById('stones-tracker');
            tracker.innerHTML = Array(state.stonesLeft).fill(0).map(() => `<div class="w-1.5 h-1.5 rounded-full bg-slate-300"></div>`).join('');

            const indicator = document.getElementById('turn-indicator');
            const currentT = state.turn === 1 ? team1 : team2;
            indicator.innerText = `${currentT.name} joga`;
            indicator.style.backgroundColor = currentT.color;

            const btn = document.getElementById('launch-btn');
            const txt = document.getElementById('launch-text');
            const spinUi = document.getElementById('spin-ui');
            const powerUi = document.getElementById('power-ui');

            if (state.gameOver) { 
                btn.style.display = 'none'; 
                spinUi.style.display = 'none';
                powerUi.style.display = 'none';
                return; 
            }

            if (anyMoving) {
                btn.classList.add('opacity-50', 'pointer-events-none');
                spinUi.style.opacity = '0';
                spinUi.classList.add('pointer-events-none');
                txt.innerText = state.isSweeping ? "VARRENDO!" : "AGUARDE";
                document.getElementById('replay-btn').style.display = 'none';
                powerUi.style.opacity = '0';
            } else {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                btn.style.backgroundColor = currentT.color;
                if (state.readyToLaunch) {
                    btn.classList.add('ready');
                    txt.innerText = "LANCE!";
                    spinUi.style.opacity = '1';
                    spinUi.classList.remove('pointer-events-none');
                    powerUi.style.opacity = '1';
                } else {
                    btn.classList.remove('ready');
                    txt.innerText = "PREPARAR";
                    spinUi.style.opacity = '0';
                    spinUi.classList.add('pointer-events-none');
                    powerUi.style.opacity = '0';
                }
            }
        }

        populateMenus();
    </script>
</body>
</html>
