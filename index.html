<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Curling Master Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f172a;
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        canvas { display: block; background: #f8fbff; }
        
        /* Telas */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            z-index: 500;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            color: white;
            justify-content: center;
            align-items: center;
        }

        /* UI de Jogo */
        .game-ui {
            position: absolute; top: 0; left: 0; right: 0;
            pointer-events: none; z-index: 100;
            padding: 10px;
        }
        .scoreboard {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 8px 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            pointer-events: auto;
            max-width: 500px; margin: 0 auto;
        }

        .power-meter {
            position: absolute; left: 50%; bottom: 120px;
            transform: translateX(-50%);
            width: 200px; height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px; overflow: hidden;
        }

        /* Bot√£o de Lan√ßamento */
        #launch-btn {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 70px; height: 70px;
            border-radius: 50%; border: 4px solid white;
            color: white; font-weight: 900; font-size: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto; cursor: pointer;
            text-align: center;
        }
        #launch-btn.ready { transform: translateX(-50%) scale(1.1); }

        /* Card de Fim de Jogo */
        #end-card {
            position: absolute; top: 80px; right: 15px;
            width: 220px; background: white; border-radius: 1rem;
            padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none; z-index: 150; pointer-events: auto;
        }

        .country-opt {
            cursor: pointer; transition: all 0.2s;
            border: 2px solid transparent;
        }
        .country-opt:hover { transform: scale(1.05); }
        .country-opt.selected { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }

        .zoom-controls {
            position: absolute; bottom: 30px; right: 20px;
            display: flex; flex-direction: column; gap: 8px;
            pointer-events: auto; z-index: 150;
        }
        .zoom-btn {
            width: 44px; height: 44px; background: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; font-size: 20px;
            color: #1e293b; cursor: pointer; user-select: none;
        }
    </style>
</head>
<body>

    <!-- Tela Inicial -->
    <div id="start-screen" class="screen">
        <h1 class="text-4xl font-black italic mb-8 tracking-tighter uppercase">Curling Master</h1>
        
        <div class="grid grid-cols-2 gap-4 w-full max-w-md mb-8">
            <div class="space-y-2">
                <p class="text-[10px] font-bold uppercase text-slate-400">Time 1</p>
                <div id="team1-list" class="grid grid-cols-2 gap-2"></div>
            </div>
            <div class="space-y-2">
                <p class="text-[10px] font-bold uppercase text-slate-400">Time 2</p>
                <div id="team2-list" class="grid grid-cols-2 gap-2"></div>
            </div>
        </div>

        <button onclick="startGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-black px-12 py-4 rounded-full transition-all shadow-xl shadow-blue-900/40 uppercase italic tracking-widest">
            Come√ßar Partida
        </button>
    </div>

    <!-- UI de Jogo -->
    <div class="game-ui">
        <div class="scoreboard">
            <div class="flex items-center gap-3">
                <div id="ui-t1-flag" class="text-2xl">üáßüá∑</div>
                <div>
                    <div id="ui-t1-name" class="text-[10px] font-black uppercase text-slate-400 leading-none">BRA</div>
                    <div id="ui-t1-score" class="text-xl font-black leading-tight">0</div>
                </div>
            </div>

            <div class="flex flex-col items-center">
                <div id="turn-indicator" class="text-[9px] font-black uppercase tracking-tighter bg-green-500 text-white px-3 py-1 rounded-full mb-1">Brasil joga</div>
                <div class="flex gap-1" id="stones-tracker"></div>
            </div>

            <div class="flex items-center gap-3 text-right">
                <div>
                    <div id="ui-t2-name" class="text-[10px] font-black uppercase text-slate-400 leading-none">ARG</div>
                    <div id="ui-t2-score" class="text-xl font-black leading-tight">0</div>
                </div>
                <div id="ui-t2-flag" class="text-2xl">üá¶üá∑</div>
            </div>
        </div>
    </div>

    <!-- Barra de For√ßa -->
    <div class="power-meter">
        <div id="power-fill" class="h-full w-0 bg-gradient-to-r from-green-400 via-yellow-400 to-red-500"></div>
    </div>

    <!-- Controles de Zoom -->
    <div class="zoom-controls">
        <div class="zoom-btn" onclick="adjustZoom(0.2)">Ôºã</div>
        <div class="zoom-btn" onclick="adjustZoom(-0.2)">Ôºç</div>
    </div>

    <!-- Card de Resultado Final -->
    <div id="end-card">
        <h3 class="text-xs font-black uppercase mb-2 text-slate-800">An√°lise da Casa</h3>
        <div id="end-summary" class="text-sm font-bold text-blue-600 mb-3"></div>
        <div id="mini-dist-list" class="space-y-1 mb-3 max-h-[150px] overflow-y-auto"></div>
        <button onclick="location.reload()" class="w-full bg-slate-800 text-white text-[10px] py-2 rounded-lg font-bold">NOVA PARTIDA</button>
    </div>

    <div id="launch-btn" style="background-color: #22c55e;">
        <span class="text-lg">ü•å</span>
        <span id="launch-text">PREPARAR</span>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const COUNTRIES = [
            { id: 'bra', name: 'Brasil', flag: 'üáßüá∑', color: '#22c55e' },
            { id: 'arg', name: 'Argentina', flag: 'üá¶üá∑', color: '#3b82f6' },
            { id: 'can', name: 'Canad√°', flag: 'üá®üá¶', color: '#ef4444' },
            { id: 'sco', name: 'Esc√≥cia', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø', color: '#1e40af' },
            { id: 'swe', name: 'Su√©cia', flag: 'üá∏üá™', color: '#fbbf24' },
            { id: 'nor', name: 'Noruega', flag: 'üá≥üá¥', color: '#991b1b' },
            { id: 'jap', name: 'Jap√£o', flag: 'üáØüáµ', color: '#f87171' },
            { id: 'usa', name: 'EUA', flag: 'üá∫üá∏', color: '#1e293b' }
        ];

        let team1 = COUNTRIES[0];
        let team2 = COUNTRIES[1];

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const PHYSICS = {
            friction: 0.988,        // Um pouco mais de fric√ß√£o para ir mais devagar
            sweepFriction: 0.995,   // Varredura reduz a fric√ß√£o
            stopThreshold: 0.15, 
            maxInitialVel: 11.5,    // Velocidade m√°xima reduzida
            stoneRadius: 10,
            houseRadius: 80,
            rinkWidth: 350,
            powerFillSpeed: 0.6,
            houseY: 50
        };

        let state = {
            width: 0, height: 0,
            stones: [],
            currentStone: null,
            readyToLaunch: false,
            isCharging: false,
            power: 0,
            stonesLeft: 8,
            turn: 1, 
            mouseX: 0, mouseY: 0,
            isSweeping: false,
            isPanning: false,
            panStartY: 0,
            gameOver: false,
            camera: { x: 0, y: 500, zoom: 1 },
            scoringStones: []
        };

        function populateMenus() {
            const t1 = document.getElementById('team1-list');
            const t2 = document.getElementById('team2-list');
            COUNTRIES.forEach(c => {
                t1.appendChild(createCountryBtn(c, 1));
                t2.appendChild(createCountryBtn(c, 2));
            });
            updateSelectionUI();
        }

        function createCountryBtn(c, teamNum) {
            const div = document.createElement('div');
            div.className = `country-opt p-2 bg-slate-800 rounded-lg flex items-center justify-center gap-2 text-sm font-bold`;
            div.innerHTML = `<span>${c.flag}</span> <span class="hidden sm:inline">${c.id.toUpperCase()}</span>`;
            div.onclick = () => {
                if (teamNum === 1) team1 = c; else team2 = c;
                updateSelectionUI();
            };
            div.dataset.id = c.id;
            div.dataset.team = teamNum;
            return div;
        }

        function updateSelectionUI() {
            document.querySelectorAll('.country-opt').forEach(btn => {
                const teamNum = parseInt(btn.dataset.team);
                const currentId = teamNum === 1 ? team1.id : team2.id;
                btn.classList.toggle('selected', btn.dataset.id === currentId);
            });
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui-t1-flag').innerText = team1.flag;
            document.getElementById('ui-t1-name').innerText = team1.id.toUpperCase();
            document.getElementById('ui-t2-flag').innerText = team2.flag;
            document.getElementById('ui-t2-name').innerText = team2.id.toUpperCase();
            initGame();
        }

        function initGame() {
            resize();
            window.addEventListener('resize', resize);
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mousedown', handleMouseDown);
            window.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('touchstart', handleTouchStart, {passive: false});
            window.addEventListener('touchmove', handleTouchMove, {passive: false});
            window.addEventListener('touchend', handleTouchEnd);
            document.getElementById('launch-btn').addEventListener('click', toggleLaunchReady);
            requestAnimationFrame(update);
            updateUI();
        }

        function resize() {
            state.width = window.innerWidth;
            state.height = window.innerHeight;
            canvas.width = state.width;
            canvas.height = state.height;
            resetZoom();
        }

        function resetZoom() {
            state.camera.zoom = Math.min(state.width / 400, state.height / 1000);
            state.camera.y = state.gameOver ? PHYSICS.houseY : 500;
            state.camera.x = 0;
        }

        function adjustZoom(delta) {
            state.camera.zoom = Math.max(0.1, Math.min(5, state.camera.zoom + delta));
        }

        function toggleLaunchReady(e) {
            e.stopPropagation();
            if (state.gameOver || state.stones.some(s => s.moving)) return;
            state.readyToLaunch = !state.readyToLaunch;
            if (state.readyToLaunch) state.camera.y = 850;
            updateUI();
        }

        function handleMouseDown(e) {
            if (e.target.closest('.scoreboard') || e.target.closest('#launch-btn') || e.target.closest('#end-card') || e.target.closest('.zoom-controls')) return;
            const anyMoving = state.stones.some(s => s.moving);
            if (anyMoving && state.currentStone?.moving) {
                state.isSweeping = true;
            } else if (state.readyToLaunch && !state.gameOver) {
                state.isCharging = true;
                state.power = 0;
            } else {
                state.isPanning = true;
                state.panStartY = e.clientY;
            }
        }

        function handleMouseMove(e) {
            updateMousePos(e.clientX, e.clientY);
            if (state.isPanning) {
                state.camera.y -= (e.clientY - state.panStartY) / state.camera.zoom;
                state.panStartY = e.clientY;
            }
        }

        function handleMouseUp() {
            if (state.isCharging) { launchStone(); state.isCharging = false; state.readyToLaunch = false; }
            state.isSweeping = false; state.isPanning = false; updateUI();
        }

        function handleTouchStart(e) {
            if (e.target.closest('.scoreboard') || e.target.closest('#launch-btn') || e.target.closest('#end-card') || e.target.closest('.zoom-controls')) return;
            const touch = e.touches[0];
            updateMousePos(touch.clientX, touch.clientY);
            if (state.stones.some(s => s.moving) && state.currentStone?.moving) {
                state.isSweeping = true;
            } else if (state.readyToLaunch && !state.gameOver) {
                state.isCharging = true;
                state.power = 0;
            } else {
                state.isPanning = true;
                state.panStartY = touch.clientY;
            }
        }

        function handleTouchMove(e) {
            const touch = e.touches[0];
            updateMousePos(touch.clientX, touch.clientY);
            if (state.isPanning) {
                state.camera.y -= (touch.clientY - state.panStartY) / state.camera.zoom;
                state.panStartY = touch.clientY;
            }
        }

        function handleTouchEnd() { handleMouseUp(); }

        function updateMousePos(ix, iy) {
            state.mouseX = (ix - state.width/2) / state.camera.zoom + state.camera.x;
            state.mouseY = (iy - state.height/2) / state.camera.zoom + state.camera.y;
        }

        function launchStone() {
            const startX = 0, startY = 950;
            const angle = Math.atan2(state.mouseY - startY, state.mouseX - startX);
            const force = (state.power / 100) * PHYSICS.maxInitialVel;
            const activeTeam = state.turn === 1 ? team1 : team2;
            
            const stone = {
                id: Date.now(),
                x: startX, y: startY,
                vx: Math.cos(angle) * force,
                vy: Math.sin(angle) * force,
                team: state.turn,
                color: activeTeam.color,
                flag: activeTeam.flag,
                handleColor: '#ffffff',
                moving: true
            };
            state.stones.push(stone);
            state.currentStone = stone;
            state.stonesLeft--;
            state.turn = state.turn === 1 ? 2 : 1;
        }

        function update() {
            ctx.clearRect(0, 0, state.width, state.height);
            ctx.save();
            ctx.translate(state.width/2, state.height/2);
            ctx.scale(state.camera.zoom, state.camera.zoom);
            ctx.translate(-state.camera.x, -state.camera.y);

            drawRink();

            if (state.isCharging) {
                state.power = Math.min(state.power + PHYSICS.powerFillSpeed, 100);
                document.getElementById('power-fill').style.width = state.power + '%';
            }

            let stoneStoppedThisFrame = false;
            state.stones.forEach(s => {
                if (s.moving) {
                    const f = (state.isSweeping && s === state.currentStone) ? PHYSICS.sweepFriction : PHYSICS.friction;
                    s.vx *= f; s.vy *= f;
                    s.x += s.vx; s.y += s.vy;
                    if (Math.sqrt(s.vx*s.vx + s.vy*s.vy) < PHYSICS.stopThreshold) {
                        s.vx = 0; s.vy = 0; s.moving = false;
                        stoneStoppedThisFrame = true;
                    }
                    state.camera.y = s.y;
                }
                drawStone(s);
            });

            if (stoneStoppedThisFrame) {
                updateUI();
                if (state.stonesLeft === 0 && !state.stones.some(s => s.moving)) calculateScore();
            }

            checkCollisions();
            drawGuides();
            ctx.restore();
            requestAnimationFrame(update);
        }

        function checkCollisions() {
            for (let i = 0; i < state.stones.length; i++) {
                for (let j = i + 1; j < state.stones.length; j++) {
                    const s1 = state.stones[i], s2 = state.stones[j];
                    const dx = s2.x - s1.x, dy = s2.y - s1.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < PHYSICS.stoneRadius * 2) {
                        const angle = Math.atan2(dy, dx);
                        const sin = Math.sin(angle), cos = Math.cos(angle);
                        const vx1 = s1.vx * cos + s1.vy * sin, vy1 = s1.vy * cos - s1.vx * sin;
                        const vx2 = s2.vx * cos + s2.vy * sin, vy2 = s2.vy * cos - s2.vx * sin;
                        s1.vx = vx2 * cos - vy1 * sin; s1.vy = vy1 * cos + vx2 * sin;
                        s2.vx = vx1 * cos - vy2 * sin; s2.vy = vy2 * cos + vx1 * sin;
                        const overlap = (PHYSICS.stoneRadius * 2 - dist) / 2;
                        s1.x -= overlap * cos; s1.y -= overlap * sin;
                        s2.x += overlap * cos; s2.y += overlap * sin;
                        s1.moving = s2.moving = true;
                    }
                }
            }
        }

        function drawRink() {
            const w = PHYSICS.rinkWidth, houseY = PHYSICS.houseY; 
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(-w/2, -500, w, 2000);
            
            const rings = [
                { r: PHYSICS.houseRadius, c: '#3b82f6' }, 
                { r: PHYSICS.houseRadius * 0.66, c: '#ffffff' }, 
                { r: PHYSICS.houseRadius * 0.33, c: '#ef4444' }, 
                { r: 12, c: '#ffffff' }
            ];
            rings.forEach(ring => {
                ctx.beginPath(); ctx.arc(0, houseY, ring.r, 0, Math.PI * 2);
                ctx.fillStyle = ring.c; ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.stroke();
            });

            ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, -500); ctx.lineTo(0, 1500); ctx.stroke();
            ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(-w/2, 800); ctx.lineTo(w/2, 800); ctx.stroke();
        }

        function drawStone(s) {
            const isScoring = state.scoringStones.includes(s.id);
            
            // Halo de pontua√ß√£o
            if (isScoring) {
                ctx.beginPath(); ctx.arc(s.x, s.y, PHYSICS.stoneRadius + 4, 0, Math.PI * 2);
                ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 3; ctx.stroke();
            }

            // Corpo da pedra
            ctx.beginPath(); ctx.arc(s.x, s.y, PHYSICS.stoneRadius, 0, Math.PI * 2);
            ctx.fillStyle = s.color; ctx.fill();
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 1; ctx.stroke();
            
            // Puxador
            ctx.beginPath(); ctx.arc(s.x, s.y, PHYSICS.stoneRadius * 0.55, 0, Math.PI * 2);
            ctx.fillStyle = s.handleColor; ctx.fill();

            // Bandeirinha sobre a pedra (vis√≠vel se zoom for alto)
            if (state.camera.zoom > 0.6) {
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(s.flag, s.x, s.y - 15);
            }

            // Dist√¢ncia ao centro se o jogo acabou
            if (state.gameOver) {
                const dist = Math.sqrt(s.x*s.x + (s.y - PHYSICS.houseY)**2).toFixed(1);
                ctx.fillStyle = "#1e293b"; ctx.font = "bold 9px Inter";
                ctx.fillText(dist, s.x, s.y + 24);
            }
        }

        function drawGuides() {
            if (state.isCharging) {
                const startY = 950;
                const maxLength = 220 - (state.power * 1.5);
                const angle = Math.atan2(state.mouseY - startY, state.mouseX);
                
                ctx.beginPath();
                ctx.moveTo(0, startY);
                ctx.lineTo(Math.cos(angle) * maxLength, startY + Math.sin(angle) * maxLength);
                ctx.strokeStyle = `rgba(0,0,0,${0.7 - (state.power/200)})`; 
                ctx.lineWidth = 5;
                ctx.stroke();
            }

            // Efeito visual de Varredura (Sweep)
            if (state.isSweeping && state.currentStone?.moving) {
                ctx.save();
                ctx.beginPath();
                ctx.ellipse(state.currentStone.x, state.currentStone.y - 20, 25, 12, 0, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(56, 189, 248, 0.4)';
                ctx.shadowBlur = 10; ctx.shadowColor = '#38bdf8';
                ctx.fill();
                ctx.restore();
            }
        }

        function calculateScore() {
            state.gameOver = true;
            const stonesInfo = state.stones.map(s => ({
                id: s.id, team: s.team, flag: s.flag,
                dist: Math.sqrt(s.x*s.x + (s.y - PHYSICS.houseY)**2)
            })).filter(s => s.dist <= PHYSICS.houseRadius);

            stonesInfo.sort((a, b) => a.dist - b.dist);

            let s1 = 0, s2 = 0;
            if (stonesInfo.length > 0) {
                const winner = stonesInfo[0].team;
                const loser = winner === 1 ? 2 : 1;
                const firstOppStone = stonesInfo.find(s => s.team === loser);
                const limit = firstOppStone ? firstOppStone.dist : PHYSICS.houseRadius + 1;
                const winners = stonesInfo.filter(s => s.team === winner && s.dist < limit);
                if (winner === 1) s1 = winners.length; else s2 = winners.length;
                state.scoringStones = winners.map(w => w.id);
            }

            document.getElementById('ui-t1-score').innerText = s1;
            document.getElementById('ui-t2-score').innerText = s2;
            document.getElementById('end-summary').innerText = s1 > s2 ? `${team1.name} Ganhou!` : (s2 > s1 ? `${team2.name} Ganhou!` : "Empate!");
            
            const list = document.getElementById('mini-dist-list');
            list.innerHTML = state.stones.sort((a,b) => {
                const d1 = Math.sqrt(a.x*a.x + (a.y - PHYSICS.houseY)**2);
                const d2 = Math.sqrt(b.x*b.x + (b.y - PHYSICS.houseY)**2);
                return d1 - d2;
            }).map(s => {
                const dist = Math.sqrt(s.x*s.x + (s.y - PHYSICS.houseY)**2);
                const inHouse = dist <= PHYSICS.houseRadius;
                return `<div class="flex justify-between items-center text-[11px] p-1.5 border-b ${inHouse ? 'bg-blue-50' : 'opacity-40'}">
                    <span>${s.flag} Pedra</span> 
                    <span class="font-mono font-bold">${dist.toFixed(1)}u</span>
                </div>`;
            }).join('');

            document.getElementById('end-card').style.display = 'block';
            updateUI();
        }

        function updateUI() {
            const anyMoving = state.stones.some(s => s.moving);
            const tracker = document.getElementById('stones-tracker');
            tracker.innerHTML = Array(state.stonesLeft).fill(0).map(() => `<div class="w-1.5 h-1.5 rounded-full bg-slate-300"></div>`).join('');

            const indicator = document.getElementById('turn-indicator');
            const currentT = state.turn === 1 ? team1 : team2;
            indicator.innerText = `${currentT.name} joga`;
            indicator.style.backgroundColor = currentT.color;

            const btn = document.getElementById('launch-btn');
            const txt = document.getElementById('launch-text');

            if (state.gameOver) { 
                btn.style.display = 'none'; 
                document.querySelector('.power-meter').style.display = 'none';
                return; 
            }

            if (anyMoving) {
                btn.classList.add('opacity-50', 'pointer-events-none');
                txt.innerText = state.isSweeping ? "VARRENDO!" : "AGUARDE";
            } else {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                btn.style.backgroundColor = currentT.color;
                if (state.readyToLaunch) {
                    btn.classList.add('ready');
                    txt.innerText = "LANCE!";
                } else {
                    btn.classList.remove('ready');
                    txt.innerText = "PREPARAR";
                }
            }
        }

        populateMenus();
    </script>
</body>
</html>
